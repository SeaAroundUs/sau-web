;(function() {

  'use strict';

  angular.module('sauWebApp')
  .controller('ExploitedOrganismsCtrl', function ($scope, $routeParams, $q, $filter, uiGridConstants, sauAPI, region) {

    $scope.model = {
      taxon_level: {},
      taxon_group: {},
    };

    $scope.region_id = $routeParams.id;

    $scope.selectRow = function(row) {
      console.log(row.entity);
      var taxon = sauAPI.Taxon.get({taxon_key: row.entity.taxon_key}, function() {
        $scope.taxon = taxon.data;
      });
    };

    function rowTemplate() {
        return '<div ng-click="grid.appScope.selectRow(row)" ng-repeat="col in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ui-grid-cell></div>';
    }

    $scope.gridOptions = {
      enableFiltering: true,
      rowTemplate: rowTemplate(),
      // want these, but they're not showing
      // enableVerticalScrollbars: uiGridConstants.scrollbars.ALWAYS,
      columnDefs: [
        {field: 'common_name'},
        {field: 'scientific_name'},
      ],
    };

    $scope.taxonChange = function() {
      $q.all([$scope.taxon_levels.$promise, $scope.taxon_groups.$promise])
        .then(function() {
          $scope.gridOptions.data = $filter('filter')($scope.allData, {
            taxon_level: $scope.model.taxon_level.taxon_level_id,
            taxon_group: $scope.model.taxon_group.taxon_group_id
          });
        });
    };

    $scope.region = sauAPI.Region.get({region: region, region_id: $scope.region_id});
    $scope.taxon_levels = sauAPI.TaxonLevels.get(function() {
      $scope.model.taxon_level = $scope.taxon_levels.data[0];
    });
    $scope.taxon_groups = sauAPI.TaxonGroups.get(function() {
      $scope.model.taxon_group = $scope.taxon_groups.data[0];
    });

    $scope.$watch('region_id', function() {
      sauAPI.ExploitedOrganismsData.get({region: region, region_id: $scope.region_id}, function(response) {
          $scope.allData = response.data;
          $scope.taxonChange();
        });
    }, true);

  });

})();