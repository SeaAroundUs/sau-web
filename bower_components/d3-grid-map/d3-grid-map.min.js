(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
var Grid=require("./grid.js"),Utils=require("./utils.js"),Data={arrayBufferToGeoJSON:function(r){for(var e={type:"FeatureCollection",features:[],_cache:{}},t=new Uint32Array(r),a=0;a<t.length;a++){var o=t[a],n=1048575&o,i=o>>>24,u=this.cellIdToCoordinates(n),l={type:"Feature",id:a,geometry:{type:"Polygon",coordinates:[u]},properties:{cellId:n,value:i}};e.features.push(l),e._cache[n]=l}return e},packedBinaryArrayBufferToGrid:function(r,e,t){for(var a=e[1],o=e[0],n=new Uint8ClampedArray(a*o*4),i=new Uint32Array(r),u=[],l=0;l<i.length;l++){var s=i[l],y=1048575&s,d=y<<2,f=s>>>24,c=d3.rgb(t(f)),p=255;n[d+0]=c.r,n[d+1]=c.g,n[d+2]=c.b,n[d+3]=p,u[y]=f}return new Grid(n,e,u)},arrayToGrid:function(r,e,t){for(var a=e[1],o=e[0],n=new Uint32Array(a*o),i=typeof t(0),u=0,l=r.length;l>u;u++){var s=r[u];if(s==s){var y=t(s);"string"===i&&(y=Utils.colorStringToUint32(y)),n[u]=y}}return new Grid(n,e,r)},uInt8ArrayToGeoJSON:function(r){for(var e={type:"FeatureCollection",features:[]},t=0;t<r.length;t+=4){var a=t/4+1,o=r[t],n=r[t+1],i=r[t+2],u=r[t+3];if(0!==o||0!==n||0!==i||0!==u){var l=this.cellIdToCoordinates(a),s={type:"Feature",id:t,geometry:{type:"Polygon",coordinates:[l]},properties:{rgba:[o,n,i,u]}};e.features.push(s)}}return e}};module.exports=Data;

},{"./grid.js":2,"./utils.js":7}],2:[function(require,module,exports){
var Grid=function(t,i,s){this.data=t,this.rows=i[1],this.cols=i[0],this.rawData=s,this.cellCache=[],this.getCell=function(t){return this.rawData?this.rawData[t]:void 0},this.cellIdToLonLat=function(t){var i=t-1,s=-180+i%this.cols/this.cols*this.rows,e=90-~~(i/this.cols)*(180/this.rows);return[s,e]},this.coordinatesToCellId=function(t){var i=t[0],s=t[1],e=~~(this.rows-(s+90)/180*this.rows),o=~~((i+180)/360*this.cols),r=e*this.cols+o+1;return r},this.cellIdToCoordinates=function(t){if(this.cellCache[t])return this.cellCache[t];rows=this.rows,cols=this.cols;var i=360/cols,s=180/rows,e=this.cellIdToLonLat(t),o=[e,[e[0]+i,e[1]],[e[0]+i,e[1]-s],[e[0],e[1]-s],e];return this.cellCache[t]=o,o},this.screenCoordinatesToGridIndex=function(t,i){var s=i.invert(t);if(s){var e=s[0],o=s[1];if(180>=e&&e>=-180&&90>=o&&o>=-90){var r=~~(~~((90-o)/180*this.rows)*this.cols+(180+e)/360*this.cols+1);return r}}},this.getIndexMap=function(t){var i=[t.projection.rotate().slice(0,2).join("-"),t.projection.scale(),t.width,t.height].join("-"),s=null,e=t;if(e.indexMapCache&&e.indexMapCache[i])s=e.indexMapCache[i];else{s=new Uint32Array(t.height*t.width);for(var o=t.width,r=t.height,h=0,n=r*o;n>h;h++)s[h]=this.screenCoordinatesToGridIndex([h%o,h/o],t.projection);e.indexMapCache={},e.indexMapCache[i]=s}return s}};module.exports=Grid;

},{}],3:[function(require,module,exports){
var HUD=function(t){var e=t.options.hud||{},o=t.container.append("canvas");o.style("position","absolute").style("top","0px").style("left","0px").data([Number.MAX_VALUE]);var a=o.node().getContext("2d");this.context=a;var i=t.options.graticule||d3.geo.graticule()();this.resize=function(t,e){o.attr("width",t),o.attr("height",e)},this.drawGraticule=function(){a.beginPath(),t.path.context(a)(i),a.closePath(),a.lineWidth=t.graticuleWidth,a.strokeStyle=t.graticuleColor,a.stroke()},this.update=function(o,i,r){var l=d3.format(" >+7.3f"),n=e.fontSize||30,c=e.verticalOffset||10,d=e.fontColor||"white",s=e.fontFace||"monospace",h=n+"px "+s,f=n+c,u=a.createLinearGradient(0,0,0,f),p=t.width,g=t.height;u.addColorStop(0,"rgba(0,0,0,0.0)"),u.addColorStop(1,"rgba(0,0,0,1.0)"),a.clearRect(0,0,p,g),this.drawGraticule(),a.save(),a.translate(0,g-f),a.fillStyle=u,a.fillRect(0,0,p,f);var v=["cell:",o,"(",l(i[0]),"°,",l(i[1]),"°)"].join("");void 0!==r&&(v+=" value: "+d3.format(".4e")(r)),a.font=h,a.fillStyle=d,a.fillText(v,0,f-c),a.restore();var y={type:"Feature",geometry:{type:"Polygon",coordinates:[t.getGrid().cellIdToCoordinates(o)]}};a.beginPath(),a.strokeStyle="white",a.lineWidth=2,t.path.context(a)(y),a.stroke()},this.draw=function(){a.clearRect(0,0,t.width,t.height),this.drawGraticule()}};module.exports=HUD;

},{}],4:[function(require,module,exports){
var DataImport=require("./data-import.js"),Grid=require("./grid.js"),HUD=require("./hud.js"),Layer=require("./layer.js"),Legend=require("./legend.js"),Utils=require("./utils.js");try{new Uint8ClampedArray}catch(e){window.Uint8ClampedArray=Uint8Array}var defaultColorScale=d3.scale.linear().domain([0,255]).range(["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"]),GridMap=function(t,e){var o=this;this.container=d3.select(t);var i=this.container.node().getBoundingClientRect();this.width=0|i.width,this.height=0|i.height,this.layers=[],this.options=e||{},this.seaColor=this.options.seaColor||"rgba(21,98,180,.8)",this.graticuleColor=this.options.graticuleColor||"rgba(255,255,255,.3)",this.graticuleWidth=this.options.graticuleWidth||1;var n=-this.options.latitude||0,r=-this.options.longitude||0,s=this.options.scale||150;o.area=1,this.dispatch=d3.geo.GridMap.dispatch,this.projection=this.options.projection||d3.geo.aitoff(),this.projection.translate([this.width/2,this.height/2]).clipExtent([[0,0],[o.width,o.height]]).scale(s).rotate([r,n]),this.canvas=this.container.append("canvas").style("position","absolute").style("top","0px").style("left","0px"),this.canvas.data([0]),this.context=this.canvas.node().getContext("2d");var a=d3.geo.transform({point:function(t,e,i){i>=o.area&&this.stream.point(t,e)}});this.simplifyingPath=d3.geo.path().projection({stream:function(t){return a.stream(o.projection.stream(t))}}),this.path=d3.geo.path().projection(this.projection);var d=new HUD(this,e.hud);this.colorScale=this.options.colorScale||defaultColorScale,this.options.zoomLevels||(this.options.zoomLevels=[1,2,4,8]),this.options.legend&&(this.options.context=d.context,this.options.colorScale=this.colorScale,this.legend=new Legend(this.options),this.legend.draw()),this.init=function(){this.initEvents(),this.resize()},this.getGrid=function(){for(var t=[],e=0;e<this.layers.length;e++)this.layers[e].grid&&this.layers[e].visible&&t.push(this.layers[e].grid);return 1===t.length?t[0]:t.length>0?t:void 0},this.onMouseMove=function(){if(o.options.onCellHover||o.options.hud||o.options.onMouseMove){var t=o.projection.invert(d3.mouse(this));if(o.options.onMouseMove&&o.options.onMouseMove(t),t){var i=null,n=null,r=o.getGrid();r&&t[0]&&t[1]&&t[0]>-180&&t[0]<180&&t[1]>-90&&t[1]<90&&(i=r.coordinatesToCellId(t),n=r.getCell(i),n&&o.options.onCellHover&&o.options.onCellHover(n,i)),e.hud&&i&&d.update(i,t,n),o.legend&&(o.legend.draw(),o.legend.highlight(n))}}},this.initEvents=function(){var t=d3.behavior.drag().on("dragstart",function(){}).on("drag",function(){r+=100*d3.event.dx/s,n-=100*d3.event.dy/s,o.projection.rotate([r,n]),o.drawAnimation()}).on("dragend",function(){o.draw()});if(!o.options.disableMouseZoom){var e=d3.behavior.zoom().on("zoomstart",function(){}).on("zoomend",function(){o.draw()}).on("zoom",function(t){s=d3.event.scale,o.area=2e4/s/s,o.projection.scale(s),o.drawAnimation()}).scale(s).scaleExtent([0,4e3]);this.container.call(e)}this.container.call(t),this.container.on("mousemove",o.onMouseMove),d3.select(window).on("resize",d3.geo.GridMap.dispatch.resize),d3.geo.GridMap.dispatch.on("resize."+o.container.attr("id"),function(){o.resize()})},this.drawWorld=function(){this.context.clearRect(0,0,this.width,this.height),this.context.beginPath(),this.path.context(this.context)({type:"Sphere"}),this.context.fillStyle=this.seaColor,this.context.fill()},this.drawLayers=function(t){for(var e=0;e<o.layers.length;e++){var i=o.layers[e],n=!t||i.options.renderOnAnimate;n?i.draw():i.clear()}},this._draw=function(){o.dispatch.drawStart(),o.drawWorld(),o.drawLayers(),d.draw(),o.dispatch.drawEnd()},this.drawAnimation=function(){var t=!0;o.drawWorld(),o.drawLayers(t),d.draw()};var h=function(t,e){var o=-1;return function(){o>-1&&window.clearTimeout(o),o=window.setTimeout(t,e)}};o.draw=h(o._draw,500),this._resize=function(){var t=o.container.node().getBoundingClientRect();o.width=0|t.width,o.height=0|t.height,o.canvas.attr("width",o.width),o.canvas.attr("height",o.height);for(var e=0;e<o.layers.length;e++)o.layers[e].resize(o.width,o.height);o.projection.translate([o.width/2,o.height/2]).clipExtent([[0,0],[o.width,o.height]]),d.resize(o.width,o.height),o.draw()},this.resize=h(o._resize,200),this.panToCentroid=function(t){var e=d3.geo.centroid(t).map(Math.round),o=this.projection.rotate().map(Math.round);o[0]=-e[0],this.projection.rotate(o)},this.addLayer=function(t,e){var i=new Layer(o,e);if(t.BYTES_PER_ELEMENT){var n=e&&e.colorScale||o.colorScale;e.colorScaleDiscrete&&n.range(n.range().map(Utils.colorStringToUint32)),i.grid=DataImport.arrayToGrid(t,e.gridSize,n)}else{if("Topology"===t.type){var r=e&&e.topojsonObject||t.objects[Object.keys(t.objects)[0]];t=topojson.feature(topojson.presimplify(t),r),i.simplified=!0}i.json=t}return o.layers.push(i),this.container.selectAll("canvas").sort(),e&&(e.renderOnAdd||void 0==e.renderOnAdd)&&o.draw(),i},this.removeLayer=function(t){if("number"==typeof t)t=o.layers.splice(t,1)[0];else for(var e=0;e<o.layers.length;e++)o.layers[e]===t&&o.layers.splice(e,1);return t.remove(),t},this.zoomTo=function(t){o.area=2e4/t/t,o.projection.scale(t),o.draw()},this.zoomIn=function(){o.options.zoomLevels.sort(function(t,e){return t-e});for(var t=o.projection.scale(),e=0;e<o.options.zoomLevels.length;e++)if(150*o.options.zoomLevels[e]>t)return void o.zoomTo(150*o.options.zoomLevels[e])},this.zoomOut=function(){o.options.zoomLevels.sort(function(t,e){return t-e});for(var t=o.projection.scale(),e=o.options.zoomLevels.length-1;e>=0;e--)if(150*o.options.zoomLevels[e]<t)return void o.zoomTo(150*o.options.zoomLevels[e])},this.init()};window.d3.geo.GridMap=GridMap,window.d3.geo.GridMap.dispatch=d3.geo.GridMap.dispatch||d3.dispatch("drawStart","drawEnd","resize");
},{"./data-import.js":1,"./grid.js":2,"./hud.js":3,"./layer.js":5,"./legend.js":6,"./utils.js":7}],5:[function(require,module,exports){
window.CanvasPixelArray&&(CanvasPixelArray.prototype.set=function(t){for(var i=this.length,s=0;i>s;s++)this[s]=t[s]});var Layer=function(t,i){this.options=i||{},this.options.strokeColor=this.options.strokeColor||"rgba(100,100,100,.8)",this.options.fillColor=this.options.fillColor||"rgba(237,178,48,1)",this.options.strokeWidth=this.options.strokeWidth||.5,void 0===this.options.zIndex&&(this.options.zIndex=1),this.options.hasOwnProperty("renderOnAnimate")||(this.options.renderOnAnimate=!0),this.visible=!0;var s=t.container.append("canvas");s.style("position","absolute").style("top","0px").style("left","0px").attr("width",t.width).attr("height",t.height).attr("z-index",this.options.zIndex).data([this.options.zIndex]);var e=s.node().getContext("2d");this.resize=function(t,i){s.attr("width",t),s.attr("height",i)},this.remove=function(){s.remove()},this.renderGridToCanvas=function(i,s){var o=e.createImageData(t.width,t.height),n=null;n=o.data.buffer?o.data.buffer:new ArrayBuffer(o.data.length);for(var r=new Uint32Array(n),a=0,h=s.length;h>a;a++)r[a]=i.data[s[a]];if(!o.data.buffer){var d=new Uint8ClampedArray(n);o.data.set(d)}e.putImageData(o,0,0)},this.drawGrid=function(i){var s=i.getIndexMap(t);this.renderGridToCanvas(this.grid,s)},this.drawGeoJSONLayer=function(){e.beginPath(),this.simplified?t.simplifyingPath.context(e)(this.json):t.path.context(e)(this.json),e.strokeStyle=this.options.strokeColor,e.lineWidth=this.options.strokeWidth,e.stroke(),e.fillStyle=this.options.fillColor,e.fill()},this.clear=function(){e.clearRect(0,0,t.width,t.height)},this.setVisible=function(t){this.visible=t,s.style("display",t?"block":"none")},this.hide=function(){this.setVisible(!1)},this.show=function(){this.setVisible(!0)},this.draw=function(){this.clear(),this.grid?this.drawGrid(this.grid):this.json&&this.drawGeoJSONLayer()}};module.exports=Layer;

},{}],6:[function(require,module,exports){
var Legend=function(e){var t=e.context,l=e.width||150,r=e.height||30,a=e.cornerOffset||{x:5,y:20},n=e.margin||5;this.complementaryColor=function(e){function t(e){return(e+127)%255}var l=d3.rgb(t(e.r),t(e.g),t(e.b));return l},this.xy=function(){return{x:t.canvas.clientWidth-l-a.x,y:t.canvas.clientHeight-r-a.y}},this.draw=function(a){var i=this.xy(),o=[{x:0,label:"0.0"},{x:51,label:"0.2"},{x:102,label:"0.4"},{x:153,label:"0.6"},{x:204,label:"0.8"},{x:255,label:"1.0"}],c=(l-2*n)/o.length;t.save(),t.translate(i.x,i.y),t.clearRect(0,0,l,r),t.fillStyle="rgba(0,0,0,.5)",t.fillRect(0,0,l,r);var h="8px Helvetica";t.font=h;for(var s=0;s<o.length;s++){var x=o[s],f=d3.rgb(e.colorScale(x.x));t.fillStyle=f,t.fillRect(s*c+n,n,c,r-2*n),t.fillStyle=this.complementaryColor(f),t.fillText(x.label,(s+.5)*c,r/2+2)}t.restore()},this.highlight=function(a){t.save();var i=this.xy();t.translate(i.x+n,i.y+n);var o=d3.rgb(e.colorScale(255*a));t.strokeStyle=this.complementaryColor(o);var c=(l-2*n)*a;t.lineWidth=2,t.beginPath(),t.moveTo(c,0),t.lineTo(c,r-2*n),t.stroke(),t.restore()}};module.exports=Legend;

},{}],7:[function(require,module,exports){
var Utils={colorStringToUint32:function(r){var t=d3.rgb(r);return 255<<24|t.b<<16|t.g<<8|t.r}};module.exports=Utils;

},{}]},{},[4]);
